<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lswd.youpin.dao.AssociatorMapper">
    <resultMap id="BaseResultMap" type="com.lswd.youpin.model.Associator">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="associator_id" jdbcType="VARCHAR" property="associatorId"/>
        <result column="account" jdbcType="VARCHAR" property="account"/>
        <result column="telephone" jdbcType="VARCHAR" property="telephone"/>
        <result column="password" jdbcType="VARCHAR" property="password"/>
        <result column="pay_password" jdbcType="VARCHAR" property="payPassword"/>
        <result column="associator_wx" jdbcType="VARCHAR" property="associatorWx"/>
        <result column="member_id" jdbcType="INTEGER" property="memberId"/>
        <result column="img" jdbcType="VARCHAR" property="img"/>
        <result column="nickname" jdbcType="VARCHAR" property="nickName"/>
        <result column="buy_service" jdbcType="VARCHAR" property="buyService"/>
        <result column="level" jdbcType="BIT" property="level"/>
        <result column="is_delete" jdbcType="BIT" property="isDelete"/>
        <result column="is_use" jdbcType="BIT" property="isUse"/>
        <result column="lock_time" jdbcType="SMALLINT" property="lockTime"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>


    </resultMap>
    <resultMap id="AssociatorListMap" type="com.lswd.youpin.model.Associator">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="associator_id" jdbcType="VARCHAR" property="associatorId"/>
        <result column="account" jdbcType="VARCHAR" property="account"/>
        <result column="associator_wx" jdbcType="VARCHAR" property="associatorWx"/>
        <result column="member_id" jdbcType="INTEGER" property="memberId"/>
        <result column="img" jdbcType="VARCHAR" property="img"/>
        <result column="pay_password" jdbcType="VARCHAR" property="payPassword"/>
        <result column="level" jdbcType="INTEGER" property="level"/>
        <result column="is_use" jdbcType="BIT" property="isUse"/>
        <result column="is_delete" jdbcType="BIT" property="isDelete"/>
        <result column="leval_name" jdbcType="VARCHAR" property="levelName"/>
        <result column="telephone" jdbcType="VARCHAR" property="telephone"/>
        <result column="state" jdbcType="VARCHAR" property="state"/>
        <result column="canteen_count" jdbcType="INTEGER" property="canteenCount"/>
        <association property="associatorAccount" javaType="com.lswd.youpin.model.AssociatorAccount">
            <id property="id" column="account_id"/>
            <result property="balance" column="balance"/>
            <result property="credit" column="credit"/>
        </association>

        <collection property="canteenList" ofType="com.lswd.youpin.model.Canteen">
            <id property="id" column="cid"/>
            <result property="canteenName" column="canteen_name"/>
            <result property="tenantId" column="tenant_id"/>
        </collection>
    </resultMap>
    <resultMap id="PayMap" type="com.lswd.youpin.model.RechargeLog">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="out_trade_no" jdbcType="VARCHAR" property="outTradeNo"/>
        <result column="associator_id" jdbcType="VARCHAR" property="associatorId"/>
        <result column="recharge_money" jdbcType="DOUBLE" property="rechargeMoney"/>
        <result column="recharge_type" jdbcType="SMALLINT" property="rechargeType"/>
        <result column="recharge_name" jdbcType="VARCHAR" property="rechargeName"/>
        <result column="account" jdbcType="VARCHAR" property="associatorName"/>
        <result column="operation_time" jdbcType="TIMESTAMP" property="operationTime"/>
    </resultMap>

    <sql id="Base_Column_List">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        id, associator_id, account, password, pay_password, associator_wx,member_id,img,nickname,
        level,
        is_delete,
        is_use, lock_time,buy_service, create_time, update_time
    </sql>
    <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select
        <include refid="Base_Column_List"/>
        from t_associator
        where id = #{id,jdbcType=INTEGER}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        delete from t_associator
        where id = #{id,jdbcType=INTEGER}
    </delete>
    <insert id="insert" parameterType="com.lswd.youpin.model.Associator">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into t_associator (id, associator_id, account,
        password, associator_wx,member_id,img,nickname,
        level, is_delete, is_use, lock_time,buy_service,
        create_time, update_time)
        values (#{id,jdbcType=INTEGER}, #{associatorId,jdbcType=VARCHAR}, #{account,jdbcType=VARCHAR},
        #{password,jdbcType=VARCHAR}, #{associatorWx,jdbcType=VARCHAR},#{memberId,jdbcType=INTEGER},
        #{img,jdbcType=VARCHAR},#{nickName,jdbcType=VARCHAR},
        #{level,jdbcType=BIT}, #{isDelete,jdbcType=BIT}, #{isUse,jdbcType=BIT},
        #{lockTime,jdbcType=SMALLINT},#{buyService,jdbcType=VARCHAR},
        #{createTime,jdbcType=TIMESTAMP}, #{updateTime,jdbcType=TIMESTAMP})
    </insert>
    <insert id="insertSelective" parameterType="com.lswd.youpin.model.Associator">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into t_associator
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="associatorId != null">
                associator_id,
            </if>
            <if test="account != null">
                account,
            </if>
            <if test="password != null">
                password,
            </if>
            <if test="payPassword != null">
                pay_password,
            </if>
            <if test="telephone != null">
                telephone,
            </if>
            <if test="associatorWx != null">
                associator_wx,
            </if>
            <if test="memberId != null">
                member_id,
            </if>
            <if test="img != null">
                img,
            </if>
            <if test="nickName != null">
                nickname,
            </if>
            <if test="level != null">
                level,
            </if>
            <if test="isDelete != null">
                is_delete,
            </if>
            <if test="sexType != null">
                sex,
            </if>
            <if test="isUse != null">
                is_use,
            </if>
            <if test="lockTime != null">
                lock_time,
            </if>
            <if test="buyService != null">
                buy_service,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="updateTime != null">
                update_time,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=INTEGER},
            </if>
            <if test="associatorId != null">
                #{associatorId,jdbcType=VARCHAR},
            </if>
            <if test="account != null">
                #{account,jdbcType=VARCHAR},
            </if>
            <if test="password != null">
                #{password,jdbcType=VARCHAR},
            </if>
            <if test="payPassword != null">
                #{payPassword,jdbcType=VARCHAR},
            </if>
            <if test="telephone != null">
                #{telephone,jdbcType=VARCHAR},
            </if>
            <if test="associatorWx != null">
                #{associatorWx,jdbcType=VARCHAR},
            </if>
            <if test="memberId != null">
                #{memberId,jdbcType=INTEGER},
            </if>
            <if test="img != null">
                #{img,jdbcType=VARCHAR},
            </if>
            <if test="nickName != null">
                #{nickName,jdbcType=VARCHAR},
            </if>
            <if test="level != null">
                #{level,jdbcType=BIT},
            </if>
            <if test="isDelete != null">
                #{isDelete,jdbcType=BIT},
            </if>
            <if test="isUse != null">
                #{isUse,jdbcType=BIT},
            </if>
            <if test="sexType != null">
                #{sexType,jdbcType=BIT},
            </if>
            <if test="lockTime != null">
                #{lockTime,jdbcType=SMALLINT},
            </if>
            <if test="buyService != null">
                #{buyService,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null">
                #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                #{updateTime,jdbcType=TIMESTAMP},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.lswd.youpin.model.Associator">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update t_associator
        <set>
            <if test="associatorId != null">
                associator_id = #{associatorId,jdbcType=VARCHAR},
            </if>
            <if test="account != null">
                account = #{account,jdbcType=VARCHAR},
            </if>
            <if test="telephone != null">
                telephone = #{telephone,jdbcType=VARCHAR},
            </if>
            <if test="img != null">
                img = #{img,jdbcType=VARCHAR},
            </if>
            <if test="nickName != null">
                nickname = #{nickName,jdbcType=VARCHAR},
            </if>
            <if test="password != null">
                password = #{password,jdbcType=VARCHAR},
            </if>
            <if test="payPassword != null">
                pay_password = #{payPassword,jdbcType=VARCHAR},
            </if>
            <if test="associatorWx != null">
                associator_wx = #{associatorWx,jdbcType=VARCHAR},
            </if>
            <if test="memberId != null">
                member_id = #{memberId,jdbcType=INTEGER},
            </if>
            <if test="img != null">
                img = #{img,jdbcType=VARCHAR},
            </if>
            <if test="level != null">
                level = #{level,jdbcType=BIT},
            </if>
            <if test="isDelete != null">
                is_delete = #{isDelete,jdbcType=BIT},
            </if>
            <if test="isUse != null">
                is_use = #{isUse,jdbcType=BIT},
            </if>
            <if test="lockTime != null">
                lock_time = #{lockTime,jdbcType=SMALLINT},
            </if>
            <if test="buyService != null">
                buy_service = #{buyService,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null">
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="sexType!=null">
                sex = #{sexType,jdbcType=BIT},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.lswd.youpin.model.Associator">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update t_associator
        set associator_id = #{associatorId,jdbcType=VARCHAR},
        account = #{account,jdbcType=VARCHAR},
        password = #{password,jdbcType=VARCHAR},
        associator_wx = #{associatorWx,jdbcType=VARCHAR},
        member_id = #{memberId,jdbcType=INTEGER},
        img = #{img,jdbcType=VARCHAR},
        nickname=#{img,jdbcType=VARCHAR},
        level = #{level,jdbcType=BIT},
        is_delete = #{isDelete,jdbcType=BIT},
        is_use = #{isUse,jdbcType=BIT},
        lock_time = #{lockTime,jdbcType=SMALLINT},
        buy_service = #{buyService,jdbcType=VARCHAR},
        create_time = #{createTime,jdbcType=TIMESTAMP},
        update_time = #{updateTime,jdbcType=TIMESTAMP},
        where id = #{id,jdbcType=INTEGER}
    </update>

    <insert id="addAssociator" parameterType="com.lswd.youpin.model.Associator">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into t_associator (associator_id, account,
        password,pay_password, telephone, is_delete, is_use,
        create_time, update_time)
        values (#{associatorId,jdbcType=VARCHAR}, #{account,jdbcType=VARCHAR},
        #{password,jdbcType=VARCHAR}, #{payPassword,jdbcType=VARCHAR}, #{telephone,jdbcType=VARCHAR},
        #{isDelete,jdbcType=BIT}, #{isUse,jdbcType=BIT}, #{createTime,jdbcType=TIMESTAMP},
        #{updateTime,jdbcType=TIMESTAMP})
    </insert>

    <select id="selectByAccount" parameterType="java.lang.String" resultMap="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select
        id,associator_id,account,`password`,pay_password,telephone,is_use,associator_wx,member_id,img,nickname,buy_service
        from t_associator
        where binary account = #{account,jdbcType=VARCHAR} OR telephone=#{account,jdbcType=VARCHAR} OR
        associator_wx=#{account,jdbcType=VARCHAR}
    </select>
    <update id="updateLockById" parameterType="com.lswd.youpin.model.Associator">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update t_associator
        set
        is_use = #{isUse,jdbcType=BIT}
        where id = #{id,jdbcType=INTEGER}
    </update>

    <update id="deleteById" parameterType="com.lswd.youpin.model.Associator">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update t_associator
        set
        is_delete = #{isDelete,jdbcType=BIT}
        where id = #{id,jdbcType=INTEGER}
    </update>

    <select id="selectAssociatorCount" resultType="java.lang.Integer">
        SELECT COUNT(co.id) from(select a.id as id from t_associator as a
        LEFT JOIN t_associator_canteen as m ON m.associator_id=a.associator_id
        LEFT JOIN t_canteen as c ON c.canteen_id=m.canteen_id
        LEFT JOIN t_associator_account as ac ON ac.associator_id=a.associator_id
        WHERE c.is_delete=0
        <if test="user.userType==true">
            and c.tenant_id = #{user.tenantId,jdbcType=VARCHAR} AND
            <foreach collection="canteenIds" item="can" separator="OR" open="(" close=")">
                c.canteen_id=#{can,jdbcType=VARCHAR}
            </foreach>
        </if>
        <if test="keyword!=''">
            and a.account like #{keyword} or a.associator_id like #{keyword}
        </if>
        GROUP BY a.associator_id
        ) as co
    </select>

    <select id="selectAssociatorList" resultMap="AssociatorListMap">
        select a.id as id,a.associator_id as associator_id,a.account as account,a.telephone,CASE a.is_use when 0 then
        '禁用' when 1 then '正常'
        end as state,a.is_use as is_use,CASE a.`level` when 0 THEN '普通会员' when 1 THEN '白金会员' when 2 THEN '黄金会员' WHEN 3
        THEN '钻石会员'
        when 4 THEN '双钻会员' end as leval_name,ac.id as accound_id ,sum(ac.balance) as balance,sum(ac.credit) as
        credit,COUNT(DISTINCT c.id) as canteen_count
        from t_associator as a LEFT JOIN t_associator_canteen as m ON m.associator_id=a.associator_id LEFT JOIN
        t_canteen as c ON
        c.canteen_id=m.canteen_id LEFT JOIN t_associator_account as ac ON ac.associator_id=a.associator_id where
        c.is_delete=0
        <if test="user.userType==true">
            AND c.tenant_id = #{user.tenantId,jdbcType=VARCHAR} AND
            <foreach collection="canteenIds" item="can" separator="OR" open="(" close=")">
                c.canteen_id=#{can,jdbcType=VARCHAR}
            </foreach>
        </if>
        <if test="keyword!=''">
            and a.account like #{keyword} or a.associator_id like #{keyword}
        </if>
        GROUP BY a.associator_id limit #{offSet},#{pageSize}
    </select>


    <select id="selectAssociatorById" resultMap="AssociatorListMap">
        SELECT a.id as id,a.account as account,a.associator_id as associator_id
        ,a.associator_wx as associator_wx,a.is_delete
        as is_delete,a.`level` as `level`,c.id as cid,c.canteen_name as canteen_name,
        c.tenant_id as tenant_id from (SELECT * from t_associator where id =#{id,jdbcType=INTEGER} )
        as a LEFT JOIN t_associator_canteen
        as s on s.associator_id=a.associator_id LEFT JOIN t_canteen as c on c.canteen_id=s.canteen_id
    </select>

    <select id="selectByAssociatorId" parameterType="java.lang.String" resultMap="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select * from t_associator
        where associator_id = #{associatorId,jdbcType=VARCHAR}
    </select>

    <select id="selectLastAssociatorId" resultType="java.lang.Integer">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select id from t_associator ORDER BY id DESC LIMIT 1
    </select>


    <select id="getAssociatorByAssociatorId" parameterType="java.lang.String" resultMap="BaseResultMap">
        select * from t_associator where associator_id = #{associatorId}
    </select>

    <select id="getPayLog" resultMap="PayMap">
        select r.id as id, a.associator_id as associator_id,a.account as account,r.out_trade_no as
        out_trade_no,r.recharge_money as recharge_money,
        r.recharge_type as recharge_type,CASE r.recharge_type WHEN 0 THEN '微信' when 1 THEN '支付宝' end as recharge_name
        ,r.operation_time
        as operation_time from t_recharge_log as r INNER JOIN t_associator as a ON a.associator_id=r.associator_id where
        r.associator_id=#{associatorId,jdbcType=VARCHAR}
        <if test="keyword!=''">
            AND ( r.out_trade_no LIKE #{keyword} OR r.operation_time LIKE #{keyword})
        </if>
        GROUP BY r.id ORDER BY r.operation_time DESC LIMIT #{offSet},#{pageSize}
    </select>

    <select id="getPlayLogCount" resultType="java.lang.Integer">
        select COUNT(co.id) from (select r.id as id from t_recharge_log
        as r INNER JOIN t_associator as a ON a.associator_id=r.associator_id
        where r.associator_id=#{associatorId,jdbcType=VARCHAR}
        <if test="keyword!=''">
            and r.out_trade_no LIKE #{keyword} OR r.operation_time LIKE #{keyword}
        </if>
        GROUP BY r.id ORDER BY r.operation_time DESC
        ) as co
    </select>

    <select id="selectById" parameterType="com.lswd.youpin.model.Associator"
            resultType="com.lswd.youpin.model.Associator">
        select id,associator_id as associatorId,account,associator_wx as associatorWx,telephone,
        CASE sex when 0 then '女' when 1 THEN '男' end as sex
        from t_associator WHERE  id=#{id}
    </select>

    <select id="selectMoney" parameterType="com.lswd.youpin.model.Associator" resultType="java.lang.Double">
        select SUM(balance) from t_associator_account WHERE associator_id=#{associatorId,jdbcType=VARCHAR} and account_type!=2
        GROUP BY associator_id
    </select>

    <delete id="deleteCanteen">
        delete from t_associator_canteen WHERE canteen_id=#{canteenId,jdbcType=VARCHAR}
        AND  associator_id=#{associatorId,jdbcType=VARCHAR}
    </delete>
    <select id="getByOpenId" parameterType="java.lang.String" resultMap="BaseResultMap">
        select  id,associator_id,account,`password`,pay_password,telephone,is_use,associator_wx,img,nickname
        from t_associator WHERE associator_wx=#{openId}
    </select>


    <select id="selectShare" resultType="com.lswd.youpin.model.AssociatorShare">
        select id as id,associator_id associatorId,share_id as shareId,count as count from t_associator_share
        WHERE associator_id=#{associatorId,jdbcType=VARCHAR} and share_id=#{shareId,jdbcType=VARCHAR}
    </select>


    <insert id="insertShare" parameterType="com.lswd.youpin.model.AssociatorShare">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into t_associator_share (associator_id,share_id ,
        count)
        values (#{associatorId,jdbcType=VARCHAR}, #{shareId,jdbcType=VARCHAR},
        #{count,jdbcType=INTEGER})
    </insert>

    <update id="updateShare" parameterType="com.lswd.youpin.model.AssociatorShare">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update t_associator_share
        set
        COUNT = #{count ,jdbcType=INTEGER}
        where id = #{id,jdbcType=INTEGER}
    </update>

    <update id="updateById">
        update t_associator set member_id=#{memberId} where id=#{id}
    </update>
</mapper>